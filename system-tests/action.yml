name: 'Ruby System Tests'
description: 'Runs Ruby system tests'

runs:
  using: "composite"
  steps:
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v1
      id: setup-chrome

    - name: Enable Corepack
      shell: bash
      run: corepack enable

    - name: Set up node
      uses: useblacksmith/setup-node@v5
      with:
        node-version-file: .node-version
        cache: yarn

    - name: Run Yarn Install
      shell: bash
      run: yarn install --frozen-lockfile

    - name: Install Ruby and gems
      uses: useblacksmith/setup-ruby@v2
      with:
        bundler-cache: true

    - name: Retrieve Cached Rails Assets
      id: cache-assets
      uses: useblacksmith/cache/restore@v5
      with:
        path: |
          public/assets
          app/assets/builds
        key: rails-assets-${{ hashFiles('app/assets/images/**/*', 'app/assets/stylesheets/**/*', 'app/javascript/**/*', 'yarn.lock', 'Gemfile.lock') }}
        fail-on-cache-miss: true

    # Technically the cache fail-on-cache-miss above should fail this flow...but it doesn't.
    # This manually fails the workflow if the cache is not found.
    - name: Fail if cache miss
      if: steps.cache-assets.outputs.cache-hit != 'true'
      shell: bash
      run: exit 1

    - name: Load previous turbo test runtime stats
      id: restore-parallel-spec
      uses: useblacksmith/cache@v5
      with:
        path: tmp/turbo_rspec_runtime.log
        key: parallel-spec-system-runtimes-${{ github.sha }}_${{ github.run_attempt }}
        restore-keys: parallel-spec-system-runtimes-

    - name: Setup parallel databases
      shell: bash
      run: bundle exec rake parallel:create parallel:load_schema

    - name: Rspec tests
      shell: bash
      run: bundle exec parallel_rspec --verbose-command spec/system
      env:
        GOOGLE_CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
        CAPYBARA_DRIVER: js

    - name: Publish Test Results
      uses: mikepenz/action-junit-report@v4
      if: success() || failure()
      with:
        check_name: Test Results
        report_paths: tmp/rspec-*.xml
        detailed_summary: true

    - name: Analyze test runtimes
      uses: RoleModel/actions/test-runtime-analyzer@v1
      with:
        test-output-path: tmp/turbo_rspec_runtime.log

    - name: Upload screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rspec-screenshots
        path: tmp/capybara

    - name: Cleanup
      uses: RoleModel/actions/test-cleanup@v1
      with:
        artifact-prefix: rspec-system
